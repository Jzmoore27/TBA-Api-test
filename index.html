<!DOCTYPE html>
<html>
    <head>
        <title>Schedule</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script type="module">
            import Cookies from '/TBA-Api-test/node_modules/js-cookie'
            $(document).ready(function(){
                var key
                $(".refresh").click(function(){
                    key = document.getElementById("key").value;
                    num = document.getElementById("num").value;
                    event = document.getElementById("event").value;
                    $.ajaxSetup({
                        'headers':{
                            'X-TBA-Auth-Key':key,
                            "Access-Control-Allow-Origin":"*"
                        }
                    });
                    $.get("https://www.thebluealliance.com/api/v3/team/frc"+num+"/event/"+event+"/matches", function(data, status){
                        table = document.getElementById("append");
                        table.innerHTML = '<tr><th class="num" style="width: 60px;">Match #</th><th class="red" style="width: 100px;">Red</th><th class="blue" style="width: 100px;">Blue</th></tr>'
                        var redTeams = []
                        var blueTeams = []
                        var row = []
                        data.sort((a,b)=>{let aoff = 0;let boff = 0;if(a.comp_level=="sf"){aoff=1000}if(a.comp_level=="f"){aoff=2000}if(b.comp_level=="sf"){boff=1000}if(b.comp_level=="f"){boff=2000}if(!((a.match_number+aoff)===(b.match_number+boff))){return (a.match_number+aoff)-(b.match_number+boff);}else{return a.predicted_time-b.predicted_time}});
                        for(i in data){
                            dat = data[i]
                            var level = "unknown";
                            row[i] = document.createElement("tr");
                            red = document.createElement("td");
                            red.innerHTML = dat.alliances.red.score;
                            red.classList.add('red');
                            if(dat.winning_alliance=="red"){red.classList.add("win");}
                            blue = document.createElement("td");
                            blue.innerHTML = dat.alliances.blue.score;
                            blue.classList.add('blue');
                            if(dat.winning_alliance=="blue"){blue.classList.add("win");}
                            num = document.createElement("td");
                            if(dat.comp_level == "qm"){level = "Qual "}
                            else if(dat.comp_level == "sf"){level = "Semis "}
                            else if(dat.comp_level == "f"){level = "Final "}
                            var d = new Date(parseInt(dat.predicted_time+"000"));
                            var hours = d.getHours()
                            var minutes = d.getMinutes()
                            var set = "AM"
                            if(hours>12){hours-=12;set="PM"}
                            if(minutes<10){minutes="0"+minutes}
                            num.innerHTML = level+dat.match_number+", "+hours+":"+minutes+set;
                            num.classList.add('num');
                            row[i].appendChild(num);
                            row[i].appendChild(red);
                            row[i].appendChild(blue);
                            redTeams[i] = []
                            for(a in dat.alliances.red.team_keys){
                                redTeams[i][a] = dat.alliances.red.team_keys[a];
                            }
                            blueTeams[i] = []
                            for(a in dat.alliances.blue.team_keys){
                                blueTeams[i][a] = dat.alliances.blue.team_keys[a];
                            }
                            eval('row['+i+'].addEventListener("mouseover", () => {for(e in redTeams['+i+']){t = document.createElement("td");t.innerHTML = redTeams['+i+'][e];t.classList.add("red");t.classList.add("del");if("'+dat.winning_alliance+'"=="red"){t.classList.add("win");}row['+i+'].appendChild(t);}for(e in blueTeams['+i+']){t = document.createElement("td");t.innerHTML = blueTeams['+i+'][e];t.classList.add("blue");t.classList.add("del");if("'+dat.winning_alliance+'"=="blue"){t.classList.add("win");}row['+i+'].appendChild(t);}});');
                            eval('row['+i+'].addEventListener("mouseout", () => {r = document.getElementsByClassName("del");while(r[0]){r[0].parentNode.removeChild(r[0]);}});');
                            table.appendChild(row[i]);
                        }
                    });
                });

                a = document.getElementById("num")
                a.addEventListener("change", (event) => {
                    key = document.getElementById("key").value;
                    select = document.getElementById("event");
                    select.innerHTML="";
                    opt = document.createElement("option");
                    opt.innerHTML = "Select a Key";
                    opt.value = ""
                    select.appendChild(opt);
                    $.ajaxSetup({
                        'headers':{
                            'X-TBA-Auth-Key':key,
                            "Access-Control-Allow-Origin":"*"
                        }
                    });
                    $.get("https://www.thebluealliance.com/api/v3/team/frc"+a.value+"/events", function(data, status){
                        for(i in data){
                            let key = data[i].key
                            opt = document.createElement("option");
                            opt.innerHTML = key;
                            opt.value = key
                            select.appendChild(opt);
                        }
                    });
                });
            });
        </script>
        <style>
            #container table tr th,td{
                outline: 1px solid #000;
                padding: 2px;
                width: 100px;
                height: 30px;
                margin:0px;
                text-align: center;
            }
            table {
                border-collapse: collapse;
                border: none;
                margin-left:1px;
                float:left;
                direction: ltr;
            }
            .red{
                background: #FF0A0A;
                font-weight: 600;
            }
            .blue{
                background: #0A0AFF;
                font-weight: 600;
            }
            .num{
                background: #CCC;
            }
            .win{
                outline: 2px solid #CCC;  
                z-index: 1000; 
            }
            #container table tr {
                opacity: 1;
                background: #FFF;
            }
            #container table tr:hover .red.blue.num{
                opacity: 0.8;
            }
            #container table tr:hover .del.red{
                background: #AA0F0F;
                opacity: 1;
                color: #CCC;
            }
            #container table tr:hover .del.blue{
                background: #0F0FAA;
                opacity: 1;
                color: #CCC;
            }
            #container table tr:hover .del.red.win{
                background: #FF0A0A;
                outline: 2px solid #CCC;
                color: #000;
            }
            #container table tr:hover .del.blue.win{
                background: #0A0AFF;
                outline: 2px solid #CCC;
                color: #000;
            }
            #container table tr:hover .del{
                outline-width: 2px;
                position: relative;
                z-index: 1000;
            }
            #container{
                width: 100%;
                margin: 0px;
                padding: 10px;
            }
            #frame{
                width: 1180px;
                height: 860px;
                border: 0;
                margin-left: 27%;
                margin-top: 20px;
                display: block;
                position: absolute;
                -ms-transform: scale(0.7);
                -moz-transform: scale(0.7);
                -o-transform: scale(0.7);
                -webkit-transform: scale(0.7);
                transform: scale(0.7);
                -ms-transform-origin: 0 0;
                -moz-transform-origin: 0 0;
                -o-transform-origin: 0 0;
                -webkit-transform-origin: 0 0;
                transform-origin: 0 0;
            }
            body{
                overflow: hidden;
                background: #3A3A3A;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
            }
            #overflow{
                height: 100%;
                width: 120%;
                margin-top: 5%;
                overflow-x: hidden;
                overflow-y: auto;
                direction: rtl;
            }
            #header{
                width: 60%;
            }
            #header h2{
                float: left;
                padding-left: 30px;
            }
            #header button{
                float: left;
                background: none;
                border: none;
                margin-top: 20px;
                transition: 0.5s;
            }
            #header button:hover{
                rotate: -15deg;
                transition: 0.5s;
            }
            #header button:active{
                rotate: -375deg;
                transition: 0s;
            }
            .r{
                float: right;
            }
            .l{
                float: left;
            }
        </style>
    </head>
    <body>
        <div id="header">
            <h2>Matches</h2>
            <button class="refresh"><img src="refresh.svg" width="30px"></button>
            <input class="l" id="key" type="text" placeholder="TBA API Key" style="width: 250px;">
            <input class="l" id="num" type="number" placeholder="Team #">
            <select class="r" id="event" name="event">
                <option value="" selected>Select a Key</option>
            </select>
        </div>
        <div id="container">
            <iframe src="https://ccshambots.github.io/ShamPit-Display/" id="frame" scrolling="no"></iframe>
            <div id="overflow">
                <table id="append">
                    <tr>
                        <th class="num" style="width: 12px;">Match #</th>
                        <th class="red" style="width: 40px;">Red</th>
                        <th class="blue" style="width: 40px;">Blue</th>
                    </tr>
                </table>
            </div>
        </div>
    </body>
</html>
